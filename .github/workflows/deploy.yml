name: Deploy to Cloudflare

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages and Workers

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (root)
        run: npm ci

      - name: Install dependencies (api)
        run: cd api && npm ci

      - name: Setup Wrangler
        run: npm install -g wrangler

      - name: Create or Get D1 Database
        id: d1-setup
        run: |
          cd api
          # Try to get existing database
          DB_LIST=$(wrangler d1 list --json 2>&1) || true
          DB_ID=$(echo "$DB_LIST" | jq -r '.[] | select(.name=="egg-guardian-db") | .uuid' 2>/dev/null || echo "")

          if [ -z "$DB_ID" ]; then
            echo "Creating new D1 database..."
            DB_OUTPUT=$(wrangler d1 create egg-guardian-db --json 2>&1)
            DB_ID=$(echo "$DB_OUTPUT" | jq -r '.uuid' 2>/dev/null || echo "")

            if [ -n "$DB_ID" ]; then
              echo "Created database with ID: $DB_ID"
            else
              echo "Failed to create database. Output:"
              echo "$DB_OUTPUT"
              # Try to extract ID from list if creation reported it already exists
              DB_ID=$(wrangler d1 list --json 2>&1 | jq -r '.[] | select(.name=="egg-guardian-db") | .uuid' 2>/dev/null || echo "")
            fi
          else
            echo "Using existing database with ID: $DB_ID"
          fi

          if [ -z "$DB_ID" ]; then
            echo "Error: Could not get or create database ID"
            exit 1
          fi

          echo "database_id=$DB_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Update wrangler.toml with database ID
        run: |
          cd api
          # Update the database_id in wrangler.toml
          if grep -q "^database_id" wrangler.toml; then
            sed -i "s/^database_id.*/database_id = \"${{ steps.d1-setup.outputs.database_id }}\"/" wrangler.toml
          else
            sed -i "/database_name = \"egg-guardian-db\"/a database_id = \"${{ steps.d1-setup.outputs.database_id }}\"" wrangler.toml
          fi

          # Also update development environment
          if grep -q "^\[\[env\.development\.d1_databases\]\]" wrangler.toml; then
            sed -i "/^\[\[env\.development\.d1_databases\]\]/,/^database_id/{s/^database_id.*/database_id = \"${{ steps.d1-setup.outputs.database_id }}\"/}" wrangler.toml
          fi

      - name: Apply Database Migrations
        run: |
          cd api
          # Apply all migrations in order
          for migration in migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying migration: $migration"
              wrangler d1 execute egg-guardian-db --remote --file="$migration"
            fi
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Set JWT Secret
        run: |
          cd api
          echo "${{ secrets.JWT_SECRET }}" | wrangler secret put JWT_SECRET --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Worker to Production
        run: |
          cd api
          wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Build Frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Copy Functions and Routes to dist
        run: |
          echo "Copying functions directory to dist..."
          cp -r functions dist/
          echo "Copying _routes.json to dist..."
          cp _routes.json dist/
          echo "Copy completed successfully"
          echo "Contents of dist/:"
          ls -la dist/
          echo "Contents of dist/functions/:"
          ls -la dist/functions/

      - name: Create or Check Pages Project
        id: pages-setup
        run: |
          # Check if project exists
          PROJECT_LIST=$(wrangler pages project list --json 2>&1) || true

          # Check if the output contains the project name (works even if JSON parsing fails)
          if echo "$PROJECT_LIST" | grep -q "egg-guardian"; then
            echo "Pages project already exists: egg-guardian"
            echo "project_created=false" >> $GITHUB_OUTPUT
          else
            echo "Creating Pages project: egg-guardian"
            wrangler pages project create egg-guardian --production-branch=main || true
            echo "project_created=true" >> $GITHUB_OUTPUT
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        run: |
          wrangler pages deploy dist \
            --project-name=egg-guardian \
            --branch=main \
            --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Configure Service Binding
        run: |
          # Configure the Service Binding for the Pages project
          # This binds the Worker (egg-guardian-api) to the Pages Functions environment variable 'API'
          ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          PROJECT_NAME="egg-guardian"

          # Get project details to find the environment
          curl -X PATCH "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/pages/projects/${PROJECT_NAME}" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "deployment_configs": {
                "production": {
                  "services": {
                    "API": {
                      "service": "egg-guardian-api",
                      "environment": "production"
                    }
                  }
                }
              }
            }'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment complete!"
          echo ""
          echo "üì¶ Database: egg-guardian-db (${{ steps.d1-setup.outputs.database_id }})"
          echo "‚ö° Worker: egg-guardian-api (production)"
          if [ "${{ steps.pages-setup.outputs.project_created }}" == "true" ]; then
            echo "üåê Pages: egg-guardian (newly created)"
          else
            echo "üåê Pages: egg-guardian (updated)"
          fi
          echo "üîó Service Binding: API ‚Üí egg-guardian-api"
          echo ""
          echo "Next steps:"
          echo "1. Verify Service Binding in Cloudflare Pages dashboard:"
          echo "   Settings ‚Üí Functions ‚Üí Service bindings"
          echo "   Should see: API = egg-guardian-api"
          echo ""
          echo "2. Configure custom domain:"
          echo "   Pages ‚Üí egg-guardian ‚Üí Custom domains"
          echo "   Add: childrenlearn.activing.fun"
          echo ""
          echo "3. Test the deployment:"
          echo "   - Frontend: https://egg-guardian.pages.dev"
          echo "   - API health: https://egg-guardian.pages.dev/api/health"
          echo "   - Custom domain (after DNS): https://childrenlearn.activing.fun"
