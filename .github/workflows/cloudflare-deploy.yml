name: Deploy to Cloudflare

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages and Workers

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (root)
        run: npm ci

      - name: Install dependencies (api)
        run: cd api && npm ci

      - name: Setup Wrangler
        run: npm install -g wrangler

      - name: Create or Get D1 Database
        id: d1-setup
        run: |
          cd api
          # Try to get existing database
          DB_ID=$(wrangler d1 list --json | jq -r '.[] | select(.name=="egg-guardian-db") | .uuid')

          if [ -z "$DB_ID" ]; then
            echo "Creating new D1 database..."
            DB_ID=$(wrangler d1 create egg-guardian-db --json | jq -r '.uuid')
            echo "Created database with ID: $DB_ID"
          else
            echo "Using existing database with ID: $DB_ID"
          fi

          echo "database_id=$DB_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Update wrangler.toml with database ID
        run: |
          cd api
          # Update the database_id in wrangler.toml
          if grep -q "^database_id" wrangler.toml; then
            sed -i "s/^database_id.*/database_id = \"${{ steps.d1-setup.outputs.database_id }}\"/" wrangler.toml
          else
            sed -i "/database_name = \"egg-guardian-db\"/a database_id = \"${{ steps.d1-setup.outputs.database_id }}\"" wrangler.toml
          fi

          # Also update development environment
          if grep -q "^\[\[env\.development\.d1_databases\]\]" wrangler.toml; then
            sed -i "/^\[\[env\.development\.d1_databases\]\]/,/^database_id/{s/^database_id.*/database_id = \"${{ steps.d1-setup.outputs.database_id }}\"/}" wrangler.toml
          fi

      - name: Apply Database Migrations
        run: |
          cd api
          # Apply all migrations in order
          for migration in migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying migration: $migration"
              wrangler d1 execute egg-guardian-db --remote --file="$migration"
            fi
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Set JWT Secret
        run: |
          cd api
          echo "${{ secrets.JWT_SECRET }}" | wrangler secret put JWT_SECRET --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Worker to Production
        run: |
          cd api
          wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Build Frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Deploy to Cloudflare Pages
        run: |
          wrangler pages deploy dist \
            --project-name=egg-guardian \
            --branch=main \
            --commit-dirty=true \
            --service-binding=API=egg-guardian-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment complete!"
          echo "üì¶ Database: egg-guardian-db (${{ steps.d1-setup.outputs.database_id }})"
          echo "‚ö° Worker: egg-guardian-api"
          echo "üåê Pages: egg-guardian"
          echo ""
          echo "Next steps:"
          echo "1. Configure custom domain in Cloudflare Pages dashboard"
          echo "2. Point childrenlearn.activing.fun to egg-guardian.pages.dev"
          echo "3. Test the deployment at your custom domain"
